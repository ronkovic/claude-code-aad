# SPEC-007: タスクループ + 完了検出

**作成日**: 2026-01-18

**担当者**: Claude Code

**ステータス**: Draft

**関連Issue**: N/A

---

## 📋 概要

ralph-tui 相当のタスクループ機能を実装し、タスクの自動進行を実現する。完了パターン検出ロジックにより、タスクの完了を自動判定し、依存関係を考慮して次のタスクを自動的に開始する。ループの中断・再開機能とリトライ機能を提供する。

---

## 🎯 目的

### ビジネス目標
タスクの自動進行により、人間の介入を最小化し、開発プロセスの効率化を実現する。完了パターンのカスタマイズにより、多様なタスクに対応した柔軟な自動化を可能にする。

### ユーザーストーリー
```
As a 開発者
I want to タスクが自動的に進行し、完了を検出する
So that 手動でタスクを管理する手間を省き、開発に集中できる
```

---

## 🔍 要件定義（MoSCoW）

### Must Have（必須）
これらがないとリリースできない機能

- [ ] **REQ-1: LoopEngine 実装** - `LoopEngine` を実装し、タスクループのメインロジックとタスクキュー管理を提供する。ループの中断・再開が可能である。
- [ ] **REQ-2: 完了パターン検出実装** - `completion-patterns.json` に基づいて完了を検出する。正規表現パターンマッチングが動作し、複数パターンの OR 条件が設定可能である。
- [ ] **REQ-3: 自動次タスク進行実装** - タスクが完了検出された場合、依存関係を考慮して次のタスクを自動的に開始する。依存タスクが未完了の場合はスキップし、リトライ機能（最大3回）を実装する。
- [ ] **REQ-4: loop コマンド実装** - `aad loop <spec-id>` でタスクループを開始する。`--resume` オプションで中断したループを再開でき、`Ctrl+C` で中断できる（状態は保存される）。

### Should Have（重要）
できるだけ含めるべき機能

- [ ] **REQ-5: ループ状態の可視化** - TUI ダッシュボードにループ状態を表示する。現在実行中のタスクがハイライト表示され、タスク進捗率が表示される。

### Could Have（あれば良い）
リソースに余裕があれば追加する機能

- なし

### Won't Have（対象外）
今回は実装しないことを明示

- [ ] **機械学習による完了予測** - 理由: 複雑すぎる
- [ ] **分散タスク実行** - 理由: 単一マシンでの実行に限定

---

## 🎨 UI/UX要件

### 画面構成
コマンドラインインターフェース + TUI ダッシュボード

### 主要な操作フロー

#### 1. タスクループ開始
```bash
$ aad loop SPEC-001
🔄 タスクループを開始しました

⏳ Task-01: Domain基盤実装 を開始...
✓ Task-01 が完了しました (検出: "All tests passed")

⏳ Task-02: 設定管理実装 を開始...
✓ Task-02 が完了しました (検出: "Build successful")

⏳ Task-03: CLI実装 を開始...
^C
⏸ ループを中断しました（状態は保存されています）
```

#### 2. ループ再開
```bash
$ aad loop SPEC-001 --resume
🔄 前回の状態から再開します

⏳ Task-03: CLI実装 を開始...（前回から再開）
✓ Task-03 が完了しました

📊 全タスク完了:
  成功: 3件
  失敗: 0件
  合計時間: 45分12秒
```

#### 3. TUI表示
```
┌─ Loop Monitor ──────────────────────────────────┐
│ SPEC-001: ユーザー認証機能                       │
│ ┌───────────────────────────────────────────┐  │
│ │ ✓ Task-01 [完了] ████████████████████     │  │
│ │ ⏳ Task-02 [実行中] ██████████░░░░░░░░░    │  │
│ │   Task-03 [待機中] ░░░░░░░░░░░░░░░░░░░░   │  │
│ └───────────────────────────────────────────┘  │
│ 進捗: 2/3 (66%)                                 │
└─────────────────────────────────────────────────┘
```

### レスポンシブ対応
N/A

---

## 🔧 技術要件

### フロントエンド
N/A

### バックエンド
- **言語**: Rust (Edition 2021)
- **正規表現**: regex クレート
- **状態保存**: JSON形式（`.aad/loop-state.json`）
- **リトライ回数**: デフォルト3回（設定可能）
- **タイムアウト**: 設定可能

### データベース
N/A

### パフォーマンス要件
- 完了パターン検出時間: 10ms以内
- タスク起動時間: 500ms以内

---

## 📊 データモデル

### ループエンジン関連構造体

#### `LoopEngine` 構造体

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| task_queue | VecDeque<TaskId> | タスクキュー |
| current_task | Option<TaskId> | 現在実行中のタスク |
| completed_tasks | HashSet<TaskId> | 完了したタスク |
| retry_counts | HashMap<TaskId, u32> | リトライ回数 |

#### `CompletionPattern` 構造体

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| patterns | Vec<String> | 正規表現パターンのリスト |
| mode | MatchMode | マッチモード（Any/All） |

#### `LoopState` 構造体
ループ状態の永続化用

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| spec_id | SpecId | 仕様ID |
| task_queue | VecDeque<TaskId> | タスクキュー |
| completed_tasks | HashSet<TaskId> | 完了したタスク |
| timestamp | DateTime | 保存日時 |

---

## 🔗 API仕様

### LoopEngine API

```rust
impl LoopEngine {
    /// 新しいLoopEngineを作成
    pub fn new(spec_id: SpecId) -> Self;

    /// タスクループを開始
    pub async fn run_loop(&mut self) -> Result<(), Error>;

    /// 次のタスクを取得
    pub fn next_task(&mut self) -> Option<TaskId>;

    /// 状態を保存
    pub fn save_state(&self) -> Result<(), Error>;

    /// 状態を復元
    pub fn restore_state(spec_id: &SpecId) -> Result<Self, Error>;
}
```

### CompletionDetector API

```rust
impl CompletionDetector {
    /// 完了を検出
    pub fn detect(&self, output: &str) -> bool;

    /// パターンを追加
    pub fn add_pattern(&mut self, pattern: String);
}
```

---

## ✅ 受け入れ基準

テスト可能な形式で記述すること

### 機能テスト

#### REQ-1: LoopEngine 実装
- [ ] AC-1.1: `application/src/loop_engine/mod.rs` に `LoopEngine` 構造体が定義されている
- [ ] AC-1.2: `run_loop(spec_id)` メソッドが実装されている
- [ ] AC-1.3: タスクキュー（`VecDeque<TaskId>`）が管理されている
- [ ] AC-1.4: 現在実行中のタスクが追跡される
- [ ] AC-1.5: ループの中断・再開が可能である

#### REQ-2: 完了パターン検出実装
- [ ] AC-2.1: `config/completion-patterns.json` ファイルが存在する
- [ ] AC-2.2: `application/src/loop_engine/completion_detector.rs` が実装されている
- [ ] AC-2.3: 正規表現パターンマッチングが動作する
- [ ] AC-2.4: 完了メッセージ（例: `"Task completed successfully"`）が検出される
- [ ] AC-2.5: 複数パターンの OR 条件が設定可能である
- [ ] AC-2.6: パターンにマッチしない場合は未完了と判定される

#### REQ-3: 自動次タスク進行実装
- [ ] AC-3.1: `next_task()` メソッドが実装されている
- [ ] AC-3.2: 依存タスクが完了している場合のみ次タスクが開始される
- [ ] AC-3.3: 依存タスクが未完了の場合はスキップされる
- [ ] AC-3.4: 全タスク完了時にループが終了する
- [ ] AC-3.5: リトライ機能が実装されている（最大3回）

#### REQ-4: loop コマンド実装
- [ ] AC-4.1: `cli/src/commands/loop.rs` が実装されている
- [ ] AC-4.2: `aad loop SPEC-001` でループが開始される
- [ ] AC-4.3: `aad loop SPEC-001 --resume` で中断したループを再開できる
- [ ] AC-4.4: `Ctrl+C` で中断できる（状態は保存される）
- [ ] AC-4.5: ループ進捗がコンソールに表示される

#### REQ-5: ループ状態の可視化
- [ ] AC-5.1: `aad monitor` でループ状態が確認できる
- [ ] AC-5.2: 現在実行中のタスクがハイライト表示される
- [ ] AC-5.3: タスク進捗率が表示される
- [ ] AC-5.4: 完了・失敗・スキップが色分けされる（緑・赤・黄）
- [ ] AC-5.5: リアルタイムで状態が更新される

### 非機能テスト
- [ ] タスクループが自動進行する
- [ ] 完了検出が正しく動作する
- [ ] 依存関係が考慮される
- [ ] エラー時の中断が適切である
- [ ] `cargo test -p application` が全て pass する

### セキュリティ
- [ ] 完了パターンの正規表現が ReDoS 攻撃に脆弱でない

---

## 🚧 制約・前提条件

### 技術的制約
- 完了パターンには正規表現ライブラリ `regex` を使用する
- タスクループの状態は `.aad/loop-state.json` に保存する
- リトライ回数とタイムアウト時間は `config/aad.toml` で設定可能とする
- 完了パターンはタスクごとにカスタマイズ可能とする

### ビジネス制約
- 期間: 1週間

### 依存関係
- SPEC-001（Domain基盤）の完了が前提
- SPEC-002（設定管理 + ワークフロー）の完了が前提
- SPEC-003（CLI基本コマンド）の完了が前提
- SPEC-004（オーケストレーション）の完了が前提
- SPEC-005（永続化）の完了が前提

---

## 🔄 マイグレーション計画

### 既存データへの影響
N/A（新規機能）

### ロールバック計画
`.aad/loop-state.json` により、任意の時点のループ状態に復元可能。

---

## 📚 参考資料

- [regex公式ドキュメント](https://docs.rs/regex/)
- [VecDeque公式ドキュメント](https://doc.rust-lang.org/std/collections/struct.VecDeque.html)
- [SPEC-001: Domain基盤](./SPEC-001.md)
- [SPEC-002: 設定管理 + ワークフロー](./SPEC-002.md)
- [SPEC-003: CLI基本コマンド](./SPEC-003.md)
- [SPEC-004: オーケストレーション](./SPEC-004.md)
- [SPEC-005: 永続化](./SPEC-005.md)

---

## 📝 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|----------|--------|
| 2026-01-18 | 1.0 | 初版作成 | Claude Code |

---

## 💬 レビューコメント

（レビュー時に追記）

---

## ✅ 承認

- [ ] 技術レビュー完了（担当: 未定、日付: 未定）
- [ ] ビジネスレビュー完了（担当: 未定、日付: 未定）
- [ ] 最終承認（担当: 未定、日付: 未定）

---

**注意**: この仕様書は承認後にタスク分割（`/aad:tasks SPEC-007`）を実行してください。
