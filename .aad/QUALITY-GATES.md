# 品質ゲート定義

各フェーズの完了条件と品質基準の詳細定義です。

---

## 🎯 品質ゲートとは

品質ゲートは、各開発フェーズが適切に完了したことを保証するためのチェックポイントです。次のフェーズに進む前に、必ず品質ゲートを通過する必要があります。

### 原則

1. **明確性**: 全ての条件が客観的に判定可能
2. **実行可能性**: 自動チェック可能な項目を優先
3. **柔軟性**: プロジェクトに応じて調整可能
4. **人間承認**: 重要な判断は人間が行う

---

## Phase 1: SPEC（仕様書作成）

### 目的
機能要件が実装可能な形式で文書化されていることを保証

### 完了条件

#### 必須項目

- [ ] **受け入れ基準がテスト可能**
  - 各要件に対して具体的なテストケースが記述可能
  - 成功・失敗の判定基準が明確
  - 例: ❌「使いやすいUI」→ ✅「ログイン完了まで3ステップ以内」

- [ ] **MoSCoWで優先度設定**
  - Must Have: 必須（リリースに不可欠）
  - Should Have: 重要（可能な限り含める）
  - Could Have: あれば良い（余裕があれば）
  - Won't Have: 対象外（明示的に除外）

- [ ] **API仕様が明確**（該当する場合）
  - エンドポイント定義
  - リクエスト/レスポンス形式
  - エラーハンドリング
  - 認証方式

- [ ] **データモデルが定義**（該当する場合）
  - テーブル構造
  - リレーションシップ
  - インデックス
  - 制約条件

#### 人間承認項目

- [ ] **技術レビュー完了**
  - 技術的実現可能性
  - パフォーマンス影響
  - セキュリティ考慮
  - 技術的負債の評価

- [ ] **ビジネスレビュー完了**
  - ビジネス価値の確認
  - 優先度の妥当性
  - ROIの評価
  - リリース時期の承認

- [ ] **最終承認**
  - 承認者名と日付を記録
  - SPEC-XXX.md の「✅ 承認」セクションに記入

### チェック方法

```bash
/aad:gate SPEC
```

### 不合格時の対応

```
❌ 受け入れ基準が曖昧
→ 具体的な数値や条件を追加

❌ 人間承認が未完了
→ SPEC-XXX.md の承認セクションを記入
```

---

## Phase 2: TASKS（タスク分割）

### 目的
SPECが実装可能な小さなタスクに適切に分割されていることを保証

### 完了条件

#### 必須項目

- [ ] **全タスクにID付与**
  - 形式: `SPEC-XXX-TYY`
  - 例: `SPEC-001-T01`, `SPEC-001-T02`
  - 連番で管理

- [ ] **依存関係が明記**
  - 各タスクの前提条件を記載
  - 並列実行可能なタスクを特定
  - 依存グラフが矛盾していない
  - 例: `T02 ← T01`（T02はT01完了後）

- [ ] **複雑度が設定**
  - S（Small）: 1-4時間
  - M（Medium）: 4-8時間
  - L（Large）: 8時間以上
  - L以上のタスクは分割を検討

- [ ] **GitHub Issuesが作成**（オプション）
  - `--no-issues`使用時はスキップ可
  - 各タスクに対応するIssue
  - ラベル設定（spec, priority, size）
  - マイルストーン設定
  - 担当者アサイン（該当する場合）

- [ ] **HANDOFF.md更新**
  - 未着手のタスク一覧に追加
  - タスク数・複雑度の集計

#### タスク品質

- [ ] **タスクが独立している**
  - 1タスク = 1機能または1変更
  - 他のタスクと疎結合
  - テストが独立して実行可能

- [ ] **変更ファイルが明確**
  - 各タスクで変更するファイル一覧
  - 影響範囲の見積もり
  - コンフリクトリスクの評価

- [ ] **テストケースが明確**
  - 各タスクのテスト方針
  - 単体テスト・統合テストの範囲
  - カバレッジ目標

#### 人間承認項目

- [ ] **タスク分割の妥当性**
  - 粒度が適切か
  - 依存関係が合理的か
  - 並列度が最適か

- [ ] **見積もりの妥当性**
  - 複雑度が適切か
  - 総工数が予算内か
  - スケジュールが現実的か

### チェック方法

```bash
/aad:gate TASKS
```

### タスク分割の例

#### 良い例

```
SPEC-001-T01: userテーブルのマイグレーション (S)
  - migrations/001_create_users.sql
  - テスト: スキーマ検証
  - 依存: なし

SPEC-001-T02: User モデル実装 (S)
  - src/models/user.ts
  - テスト: CRUD操作
  - 依存: T01

SPEC-001-T03: 認証API実装 (M)
  - src/api/auth.ts
  - テスト: 認証フロー
  - 依存: T02
```

#### 悪い例

```
❌ SPEC-001-T01: 認証機能全体 (XL)
  - 粒度が大きすぎる
  - 複数の機能が混在
  - 8時間以上かかる

❌ SPEC-001-T02: コード整理 (?)
  - 目的が不明確
  - 成果物が定義されていない
  - テスト方法が不明
```

---

## Phase 3: TDD（テスト駆動開発）

### 目的
高品質なコードが十分なテストカバレッジで実装されていることを保証

### 完了条件

#### 必須項目

- [ ] **全テストgreen**
  - 単体テスト: 100% pass
  - 統合テスト: 100% pass
  - E2Eテスト: 100% pass（該当する場合）
  - フレーキーなテストがない

- [ ] **カバレッジ80%以上**
  - Statement coverage: 80%以上
  - Branch coverage: 80%以上
  - Function coverage: 80%以上
  - Line coverage: 80%以上

- [ ] **Lint通過**
  - ESLint: 0 errors（warningは許容）
  - Prettier: フォーマット済み
  - プロジェクト固有のルール遵守

- [ ] **Type check通過**
  - TypeScript: 0 type errors
  - 型安全性が保証されている
  - `any`の使用が最小限

- [ ] **PR作成完了**
  - `gh pr create --draft`実行済み
  - PR説明が明確
  - レビュワーアサイン

#### コード品質

- [ ] **循環的複雑度が適切**
  - 関数ごとに10以下
  - ネストが深すぎない（3階層以内）
  - 早期returnで見通しを良く

- [ ] **命名が適切**
  - 意図が明確
  - 一貫した命名規則
  - 略語の使用が最小限

- [ ] **コメントが適切**
  - 複雑なロジックのみコメント
  - Whyを説明（Whatではない）
  - TODO/FIXMEに担当者とIssue番号

#### テスト品質

- [ ] **エッジケースをカバー**
  - 正常系だけでなく異常系も
  - 境界値テスト
  - null/undefined処理

- [ ] **テストが意図を表現**
  - テスト名が明確（〜すべき）
  - AAA パターン（Arrange/Act/Assert）
  - 1テスト = 1アサーション（推奨）

- [ ] **テストが独立**
  - 実行順序に依存しない
  - テストデータのクリーンアップ
  - モックの適切な使用

### チェック方法

```bash
/aad:gate TDD
```

### カバレッジレポートの例

```json
{
  "total": {
    "statements": {"pct": 85.5},
    "branches": {"pct": 82.3},
    "functions": {"pct": 90.1},
    "lines": {"pct": 85.2}
  }
}
```

### 厳格モード

プロジェクトの性質に応じて基準を調整：

```bash
# 厳格（金融・医療系）
/aad:gate TDD --strict
  - カバレッジ: 90%以上
  - Lint: 0 warnings
  - 複雑度: 5以下

# 標準（通常のプロジェクト）
/aad:gate TDD
  - カバレッジ: 80%以上
  - Lint: 0 errors
  - 複雑度: 10以下

# 緩い（プロトタイプ・実験）
/aad:gate TDD --lenient
  - カバレッジ: 70%以上
  - Lint: 重大なエラーのみ
  - 複雑度: 15以下
```

---

## Phase 4: REVIEW（コードレビュー）

### 目的
コードがチームの基準を満たし、本番環境に安全にデプロイできることを保証

### 完了条件

#### 必須項目

- [ ] **AI自己レビュー完了**
  - コードスタイルの一貫性
  - ベストプラクティスの遵守
  - セキュリティ脆弱性チェック
  - パフォーマンス懸念の確認

- [ ] **CI green**
  - GitHub Actions成功
  - 全テスト通過
  - Lintチェック通過
  - セキュリティスキャン通過

- [ ] **コンフリクトなし**
  - デフォルトブランチとの差分解消
  - マージ可能な状態
  - コンフリクトマーカーなし

- [ ] **セキュリティスキャン通過**
  - 既知の脆弱性なし
  - 依存関係の更新確認
  - シークレット情報の漏洩なし

#### レビュー観点

##### ロジック
- [ ] ビジネスロジックが正しい
- [ ] エッジケースを考慮
- [ ] エラーハンドリングが適切
- [ ] 並行処理の安全性

##### 設計
- [ ] SOLID原則に準拠
- [ ] 適切な抽象化レベル
- [ ] 依存関係が適切
- [ ] 拡張性が考慮されている

##### パフォーマンス
- [ ] N+1問題がない
- [ ] 不要なループがない
- [ ] メモリリークの可能性なし
- [ ] キャッシュ戦略が適切

##### セキュリティ
- [ ] 入力検証が適切
- [ ] SQLインジェクション対策
- [ ] XSS対策
- [ ] 認証・認可が適切
- [ ] シークレット情報のハードコードなし

##### 可読性
- [ ] コードが自己文書化
- [ ] 複雑な部分にコメント
- [ ] 一貫した命名規則
- [ ] 適切な関数分割

#### 人間承認項目

- [ ] **人間レビュー完了**
  - 最低1名のレビュワー承認
  - 指摘事項がすべて解決
  - "Approved"ステータス

- [ ] **アーキテクチャ承認**（大規模変更の場合）
  - 設計判断の妥当性
  - 技術選定の適切性
  - 長期的な保守性

### チェック方法

```bash
/aad:gate REVIEW
```

### レビューチェックリスト

#### 自動チェック
```bash
# Lint
npm run lint

# Tests
npm test

# Coverage
npm run test:coverage

# Type check
npm run type-check

# Security
npm audit
```

#### 手動チェック
- [ ] PRの説明が明確
- [ ] スクリーンショット（UI変更の場合）
- [ ] マイグレーション手順（DB変更の場合）
- [ ] ロールバック計画
- [ ] パフォーマンステスト結果

---

## Phase 5: RETRO（振り返り）

### 目的
プロジェクトから得た学びを蓄積し、プロセスを継続的に改善

### 完了条件

#### 必須項目

- [ ] **.aad/retrospectives/にログ作成**
  - ファイル名: `RETRO-SPEC-XXX-YYYYMMDD.md`
  - `.aad/templates/RETRO-TEMPLATE.md`を使用
  - 全セクションを記入

- [ ] **Keep/Problem/Try記載**
  - Keep: うまくいったこと（3つ以上）
  - Problem: 改善できること（2つ以上）
  - Try: 次回試すこと（2つ以上）

- [ ] **技術的な学び明記**
  - 具体的な事例
  - 解決策
  - 再現可能な形式
  - 次回への活用方法

- [ ] **CLAUDE.md更新提案**
  - 学びの蓄積セクションへの追加
  - コーディングルールの更新（必要に応じて）
  - プロセス改善の提案

#### 振り返りの品質

- [ ] **具体的である**
  - 抽象的な記述ではなく具体例
  - 数値で表現できるものは数値化
  - 「もっと頑張る」ではなく具体的アクション

- [ ] **実行可能である**
  - Try項目が次回すぐ試せる
  - 責任者が明確（必要に応じて）
  - 評価指標が設定されている

- [ ] **前向きである**
  - 失敗から学ぶ姿勢
  - 責任追及ではなく改善志向
  - チーム全体の成長に焦点

### チェック方法

```bash
/aad:gate RETRO
```

### 振り返りの例

#### 良い例

```markdown
### Keep: TDD でバグが早期発見できた

**状況**: 認証API実装時
**アプローチ**: テストファーストで実装
**結果**: 本番デプロイ前に3件のバグを発見
**再利用**: 今後も全API実装でTDD適用

### Problem: 見積もりが甘かった

**問題**: T03が予定8時間 → 実績12時間
**影響**: 次のタスクの開始が遅延
**原因**: 外部API連携の複雑さを過小評価
**改善案**: 外部連携は+50%の余裕を見る

### Try: ペアプログラミングを導入

**背景**: 複雑なロジックでレビュー指摘が多かった
**アクション**: 次のSPECで複雑度Mタスクにペア適用
**期待効果**: レビュー時間短縮、知識共有
**評価指標**: レビュー指摘件数の50%削減
```

---

## Phase 6: MERGE（統合・クリーンアップ）

### 目的
変更が安全にデフォルトブランチに統合され、環境がクリーンアップされていることを保証

### 完了条件

#### 必須項目

- [ ] **デフォルトブランチへマージ完了**
  - PRがデフォルトブランチにマージ済み
  - マージコミットが存在
  - ブランチが削除済み（保持が必要な場合を除く）

- [ ] **Issue閉鎖**（GitHub連携使用時）
  - GitHub Issues未使用の場合はスキップ
  - 対応するGitHub Issueがクローズ
  - クローズコメントに成果物リンク
  - 関連Issueも更新

- [ ] **worktree削除**
  - `git worktree remove`実行済み
  - ローカルブランチ削除済み
  - worktreeディレクトリが存在しない

- [ ] **デプロイ成功**（該当する場合）
  - staging環境デプロイ完了
  - smoke test通過
  - 本番環境デプロイ完了（承認後）

#### クリーンアップ

- [ ] **一時ファイルの削除**
  - ビルド成果物
  - テストカバレッジレポート
  - ログファイル

- [ ] **ドキュメント更新**
  - README更新（必要に応じて）
  - API仕様更新
  - CHANGELOG更新

### チェック方法

```bash
/aad:gate MERGE
```

### マージ確認

```bash
# デフォルトブランチに存在するか
git branch --contains <commit-hash>

# Issueがクローズされているか
gh issue view <issue-number>

# worktreeが削除されているか
git worktree list
```

---

## プロジェクト固有のカスタマイズ

CLAUDE.mdの「品質ゲート」セクションで、プロジェクト固有の基準を追加できます：

```markdown
## 📊 品質ゲート（プロジェクト固有）

### TDDフェーズ（厳格化）
- カバレッジ: 90%以上
- パフォーマンステスト必須
- アクセシビリティスコア: 95以上
- セキュリティスキャン: 脆弱性0件

### REVIEWフェーズ（追加）
- ペアプログラミング実施
- アーキテクト承認（大規模変更）
- UXレビュー（UI変更）
```

---

## 参考リンク

- [WORKFLOW.md](WORKFLOW.md) - 6フェーズワークフロー
- [COMMANDS.md](COMMANDS.md) - コマンドリファレンス
- [SETUP.md](SETUP.md) - 初期セットアップ
- [CLAUDE.md](../CLAUDE.md) - プロジェクト指示書
