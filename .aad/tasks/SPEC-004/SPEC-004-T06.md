# SPEC-004-T06: orchestrateコマンドと完了・失敗ハンドリング実装

## 複雑度: H

## 実装内容

`aad orchestrate`コマンドでオーケストレーターを起動し、登録されたSpecを実行するCLIコマンドを実装します。加えて、セッションの完了・失敗時の処理とリトライ機構を実装します。

### Part 1: セッション完了・失敗ハンドリング（Orchestrator拡張）

#### OrchestratorConfig拡張
- `max_retry_attempts: usize` - 最大リトライ回数（デフォルト: 3）
- `retry_delay_secs: u64` - リトライ間隔（デフォルト: 5秒）

#### Orchestrator拡張
- 新規フィールド: `retry_counts: Arc<RwLock<HashMap<SessionId, usize>>>`
- 新規メソッド:
  - `handle_session_completion(&self, session_id)` - 正常完了処理
  - `handle_session_failure(&self, session_id, reason)` - 失敗処理
  - `should_retry(&self, session_id)` - リトライ判定（private）
  - `retry_session(&self, session_id)` - リトライ実行（private）
  - `rollback_session(&self, session_id)` - ロールバック（private）

#### 処理フロー

**正常完了時（handle_session_completion）**:
1. セッション取得
2. ステータスをCompletedに更新
3. クリーンアップ（retry_countsから削除）
4. ログ出力 `[HANDLER:INFO]`
5. 依存セッションへの通知（将来実装）

**失敗時（handle_session_failure）**:
1. エスカレーション（escalate()呼び出し）
2. リトライ判定（should_retry()）
   - リトライ可能 → retry_session()
   - リトライ不可 → rollback_session()

**リトライ時（retry_session）**:
1. リトライ回数を更新
2. ログ出力 `[HANDLER:RETRY]`
3. 遅延処理（tokio::time::sleep）
4. ステータスをPendingにリセット
5. セッション再起動（start_session()）

**ロールバック時（rollback_session）**:
1. ログ出力 `[HANDLER:ROLLBACK]`
2. ステータスをFailedに設定
3. retry_countsから削除
4. start_timesから削除
5. リソースのクリーンアップ

### Part 2: orchestrateコマンド実装（CLI）

- `cli/src/commands/orchestrate.rs`の実装
- `--specs`オプションで複数Spec指定
- 実行ログのコンソール表示
- 結果サマリーの表示

## 変更ファイル

### 新規作成
- `crates/cli/src/commands/orchestrate.rs`

### 変更
- `crates/application/src/orchestration/config.rs`
  - `max_retry_attempts` フィールド追加
  - `retry_delay_secs` フィールド追加
- `crates/application/src/orchestration/orchestrator.rs`
  - `retry_counts` フィールド追加
  - `handle_session_completion()` メソッド追加
  - `handle_session_failure()` メソッド追加
  - `should_retry()` メソッド追加（private）
  - `retry_session()` メソッド追加（private）
  - `rollback_session()` メソッド追加（private）
  - `remove_session()` メソッド更新（retry_countsクリーンアップ）
- `crates/cli/src/commands/mod.rs`
  - orchestrateコマンド追加

## 実装順序

### Phase 1: Orchestrator拡張
1. `config.rs` - リトライ設定追加
2. `orchestrator.rs` - retry_countsフィールド追加
3. `orchestrator.rs` - should_retry() 実装
4. `orchestrator.rs` - handle_session_completion() 実装
5. `orchestrator.rs` - rollback_session() 実装
6. `orchestrator.rs` - retry_session() 実装
7. `orchestrator.rs` - handle_session_failure() 実装
8. `orchestrator.rs` - remove_session() 更新
9. テスト追加（Orchestrator部分）

### Phase 2: CLI実装
10. `cli/src/commands/orchestrate.rs` 作成
11. `cli/src/commands/mod.rs` 更新
12. テスト追加（CLI部分）

## テストケース

### Orchestrator部分
- [ ] handle_session_completion が正しく動作する
- [ ] handle_session_failure が正しく動作する
- [ ] should_retry がリトライ回数を正しく判定する
- [ ] retry_session がリトライ回数を更新する
- [ ] retry_session が遅延処理を行う
- [ ] rollback_session がクリーンアップを行う
- [ ] max_retry_attempts に達したらリトライしない
- [ ] remove_session が retry_counts をクリーンアップする

### CLI部分
- [ ] `aad orchestrate --specs SPEC-001,SPEC-002`が実行できる
- [ ] 実行ログがコンソールに表示される
- [ ] 結果サマリーが表示される
- [ ] セッション完了時に次のセッションが起動される
- [ ] セッション失敗時に適切にハンドリングされる

## 依存関係

- SPEC-004-T01（Orchestrator構造体）
- SPEC-004-T03（セッション起動ロジック）
- SPEC-004-T04（モニターループ）
- SPEC-004-T05（エスカレーション処理）

## 受け入れ基準

### Part 1: Orchestrator拡張
- [ ] AC-6.1: `OrchestratorConfig`に`max_retry_attempts`と`retry_delay_secs`が追加されている
- [ ] AC-6.2: `handle_session_completion(session_id)`メソッドが実装されている
- [ ] AC-6.3: `handle_session_failure(session_id, reason)`メソッドが実装されている
- [ ] AC-6.4: リトライ機構が正しく動作する（最大回数、間隔制御）
- [ ] AC-6.5: 正常完了時にクリーンアップが実行される
- [ ] AC-6.6: 失敗時にエスカレーションが実行される
- [ ] AC-6.7: リトライ不可時にロールバックが実行される
- [ ] AC-6.8: 完了・失敗ハンドリングのログが記録される

### Part 2: CLI実装
- [ ] AC-7.1: `cli/src/commands/orchestrate.rs`が実装されている
- [ ] AC-7.2: `aad orchestrate --specs SPEC-001,SPEC-002`で複数Specが指定可能である
- [ ] AC-7.3: 実行ログがコンソールに表示される
- [ ] AC-7.4: 実行完了時に結果サマリーが表示される

## 実装詳細

### config.rs 変更例

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct OrchestratorConfig {
    pub max_parallel_sessions: usize,
    pub session_timeout_secs: u64,
    pub monitor_interval_secs: u64,
    pub max_retry_attempts: usize,     // 新規
    pub retry_delay_secs: u64,         // 新規
}

impl Default for OrchestratorConfig {
    fn default() -> Self {
        Self {
            max_parallel_sessions: num_cpus(),
            session_timeout_secs: 3600,
            monitor_interval_secs: 1,
            max_retry_attempts: 3,
            retry_delay_secs: 5,
        }
    }
}
```

### orchestrator.rs 変更例

```rust
pub struct Orchestrator {
    config: OrchestratorConfig,
    sessions: Arc<RwLock<HashMap<SessionId, Session>>>,
    session_statuses: Arc<RwLock<HashMap<SessionId, SessionStatus>>>,
    session_start_times: Arc<RwLock<HashMap<SessionId, Instant>>>,
    dependency_graph: Arc<RwLock<DependencyGraph>>,
    retry_counts: Arc<RwLock<HashMap<SessionId, usize>>>,  // 新規
}

impl Orchestrator {
    pub async fn handle_session_completion(&self, session_id: &SessionId) -> Result<()> {
        // 実装
    }

    pub async fn handle_session_failure(
        &self,
        session_id: &SessionId,
        reason: &str,
    ) -> Result<()> {
        // 実装
    }

    async fn should_retry(&self, session_id: &SessionId) -> bool {
        // 実装
    }

    async fn retry_session(&self, session_id: &SessionId) -> Result<()> {
        // 実装
    }

    async fn rollback_session(&self, session_id: &SessionId) -> Result<()> {
        // 実装
    }
}
```

## 注意事項

- retry_countsは remove_session 時にもクリーンアップする
- 遅延処理は `tokio::time::sleep` を使用
- ログ出力パターンを monitor.rs と統一
- リトライ時は新しいstart_timeを設定
- CLI実装はPhase 1完了後に開始

## 推定時間

8-10時間（Phase 1: 5-6時間、Phase 2: 3-4時間）

## GitHub Issue

作成予定
