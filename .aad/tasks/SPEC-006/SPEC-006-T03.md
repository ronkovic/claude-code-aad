# SPEC-006-T03: Widgets実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-006-T03 |
| SPEC | SPEC-006 |
| 複雑度 | L（8時間以上） |
| 優先度 | Must |
| 依存 | T02 |
| 担当 | 未アサイン |

---

## 概要

`SessionList`, `TaskProgress`, `SpecTree`, `ContextBar`, `PhaseIndicator` の5つのWidgetを実装する。各Widgetは `ratatui::widgets::Widget` トレイトを実装する。

---

## 作業内容

### 1. widgets/mod.rs の作成
```rust
//! TUI Widgets

pub mod session_list;
pub mod task_progress;
pub mod spec_tree;
pub mod context_bar;
pub mod phase_indicator;

pub use session_list::SessionList;
pub use task_progress::TaskProgress;
pub use spec_tree::SpecTree;
pub use context_bar::ContextBar;
pub use phase_indicator::PhaseIndicator;
```

### 2. SessionList Widget の実装
`src/widgets/session_list.rs`:
```rust
use ratatui::{
    buffer::Buffer,
    layout::Rect,
    style::{Color, Style},
    widgets::{Block, Borders, List, ListItem, Widget},
};

/// セッション一覧を表示するWidget
pub struct SessionList<'a> {
    sessions: Vec<&'a str>,
    selected: usize,
}

impl<'a> SessionList<'a> {
    pub fn new(sessions: Vec<&'a str>, selected: usize) -> Self {
        Self { sessions, selected }
    }
}

impl<'a> Widget for SessionList<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let items: Vec<ListItem> = self
            .sessions
            .iter()
            .enumerate()
            .map(|(i, s)| {
                let style = if i == self.selected {
                    Style::default().bg(Color::Blue).fg(Color::White)
                } else {
                    Style::default()
                };
                ListItem::new(*s).style(style)
            })
            .collect();

        let list = List::new(items)
            .block(Block::default().title("Active Sessions").borders(Borders::ALL));

        list.render(area, buf);
    }
}
```

### 3. TaskProgress Widget の実装
`src/widgets/task_progress.rs`:
```rust
use ratatui::{
    buffer::Buffer,
    layout::Rect,
    style::{Color, Style},
    widgets::{Block, Borders, Gauge, Widget},
};

/// タスク進捗バーを表示するWidget
pub struct TaskProgress<'a> {
    label: &'a str,
    progress: f64, // 0.0 - 1.0
}

impl<'a> TaskProgress<'a> {
    pub fn new(label: &'a str, progress: f64) -> Self {
        Self { label, progress }
    }
}

impl<'a> Widget for TaskProgress<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let gauge = Gauge::default()
            .block(Block::default().title(self.label).borders(Borders::ALL))
            .gauge_style(Style::default().fg(Color::Green))
            .percent((self.progress * 100.0) as u16);

        gauge.render(area, buf);
    }
}
```

### 4. SpecTree Widget の実装
`src/widgets/spec_tree.rs`:
```rust
use ratatui::{
    buffer::Buffer,
    layout::Rect,
    widgets::{Block, Borders, List, ListItem, Widget},
};

/// Spec ツリーを表示するWidget
pub struct SpecTree<'a> {
    specs: Vec<&'a str>,
}

impl<'a> SpecTree<'a> {
    pub fn new(specs: Vec<&'a str>) -> Self {
        Self { specs }
    }
}

impl<'a> Widget for SpecTree<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let items: Vec<ListItem> = self
            .specs
            .iter()
            .map(|s| ListItem::new(*s))
            .collect();

        let list = List::new(items)
            .block(Block::default().title("Spec Tree").borders(Borders::ALL));

        list.render(area, buf);
    }
}
```

### 5. ContextBar Widget の実装（70%ルールの可視化）
`src/widgets/context_bar.rs`:
```rust
use ratatui::{
    buffer::Buffer,
    layout::Rect,
    style::{Color, Style},
    widgets::{Block, Borders, Gauge, Widget},
};

/// コンテキスト使用率を表示するWidget（70%ルール対応）
pub struct ContextBar {
    usage: f64, // 0.0 - 1.0
}

impl ContextBar {
    pub fn new(usage: f64) -> Self {
        Self { usage }
    }

    fn get_color(&self) -> Color {
        if self.usage < 0.5 {
            Color::Green // 快適
        } else if self.usage < 0.7 {
            Color::Yellow // 注意
        } else if self.usage < 0.85 {
            Color::LightRed // 警告
        } else if self.usage < 0.95 {
            Color::Red // 危機的
        } else {
            Color::Magenta // 限界
        }
    }
}

impl Widget for ContextBar {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let color = self.get_color();
        let gauge = Gauge::default()
            .block(Block::default().title("Context Usage").borders(Borders::ALL))
            .gauge_style(Style::default().fg(color))
            .percent((self.usage * 100.0) as u16);

        gauge.render(area, buf);
    }
}
```

### 6. PhaseIndicator Widget の実装
`src/widgets/phase_indicator.rs`:
```rust
use ratatui::{
    buffer::Buffer,
    layout::Rect,
    style::{Color, Modifier, Style},
    text::{Line, Span},
    widgets::{Block, Borders, Paragraph, Widget},
};

/// フェーズインジケーターを表示するWidget
pub struct PhaseIndicator<'a> {
    current_phase: &'a str,
}

impl<'a> PhaseIndicator<'a> {
    pub fn new(current_phase: &'a str) -> Self {
        Self { current_phase }
    }

    fn create_phase_line(&self) -> Line<'a> {
        let phases = vec!["SPEC", "TASKS", "TDD", "REVIEW", "RETRO"];
        let spans: Vec<Span> = phases
            .iter()
            .map(|phase| {
                if *phase == self.current_phase {
                    Span::styled(
                        format!("[{}]", phase),
                        Style::default()
                            .fg(Color::Green)
                            .add_modifier(Modifier::BOLD),
                    )
                } else {
                    Span::raw(format!(" {} ", phase))
                }
            })
            .collect();

        Line::from(spans)
    }
}

impl<'a> Widget for PhaseIndicator<'a> {
    fn render(self, area: Rect, buf: &mut Buffer) {
        let line = self.create_phase_line();
        let paragraph = Paragraph::new(line)
            .block(Block::default().title("Phase").borders(Borders::ALL));

        paragraph.render(area, buf);
    }
}
```

### 7. ユニットテストの追加
各Widget用のテストを追加（基本的な動作確認）

---

## 変更ファイル

- `crates/tui/src/widgets/mod.rs` - モジュール定義
- `crates/tui/src/widgets/session_list.rs` - 新規作成
- `crates/tui/src/widgets/task_progress.rs` - 新規作成
- `crates/tui/src/widgets/spec_tree.rs` - 新規作成
- `crates/tui/src/widgets/context_bar.rs` - 新規作成（70%ルール対応）
- `crates/tui/src/widgets/phase_indicator.rs` - 新規作成

---

## 受け入れ基準

### AC-3.1: `tui/src/widgets/session_list.rs` が実装されている
```bash
test -f crates/tui/src/widgets/session_list.rs
```

### AC-3.2: `tui/src/widgets/task_progress.rs` が実装されている
```bash
test -f crates/tui/src/widgets/task_progress.rs
```

### AC-3.3: `tui/src/widgets/spec_tree.rs` が実装されている
```bash
test -f crates/tui/src/widgets/spec_tree.rs
```

### AC-3.4: `tui/src/widgets/context_bar.rs` が実装されている（70%ルールの可視化）
```bash
test -f crates/tui/src/widgets/context_bar.rs
grep "0.7" crates/tui/src/widgets/context_bar.rs  # 70%ルールの実装確認
```

### AC-3.5: `tui/src/widgets/phase_indicator.rs` が実装されている
```bash
test -f crates/tui/src/widgets/phase_indicator.rs
```

### AC-3.6: 各 Widget が `ratatui::widgets::Widget` トレイトを実装している
```bash
grep "impl.*Widget for" crates/tui/src/widgets/*.rs | wc -l  # 5つのWidgetを確認
```

---

## テストコマンド

```bash
# ビルド確認
cargo build -p tui

# テスト実行
cargo test -p tui

# Lintチェック
cargo clippy -p tui -- -D warnings
```

---

## 期待結果

| チェック項目 | 期待結果 |
|-------------|----------|
| Widget実装 | 5つのWidget全て実装 |
| ビルド | エラーゼロ |
| テスト | 全テスト成功 |

---

## 備考

- ContextBar は70%ルールに基づく色分け実装が必須
- 各Widgetは後のタスクで View から使用される
- このタスクは複雑度 L のため、時間がかかる可能性あり
