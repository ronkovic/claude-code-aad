# SPEC-006-T06: monitor コマンド連携

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-006-T06 |
| SPEC | SPEC-006 |
| 複雑度 | M（4-8時間） |
| 優先度 | Must |
| 依存 | T05 |
| 担当 | 未アサイン |

---

## 概要

`aad monitor` コマンドでTUIダッシュボードを起動し、データを1秒ごとに定期更新する。`Ctrl+C` または `q` キーで正常終了できる。

---

## 作業内容

### 1. cli/src/commands/monitor.rs の作成
```rust
use anyhow::Result;
use clap::Args;
use crossterm::{
    execute,
    terminal::{disable_raw_mode, enable_raw_mode, EnterAlternateScreen, LeaveAlternateScreen},
};
use ratatui::{backend::CrosstermBackend, Terminal};
use std::{
    io::{stdout, Stdout},
    time::Duration,
};
use tui::{App, EventHandler};

#[derive(Debug, Args)]
pub struct MonitorArgs {
    /// 更新間隔（秒）
    #[arg(short, long, default_value = "1")]
    interval: u64,
}

pub fn execute(args: MonitorArgs) -> Result<()> {
    println!("TUIダッシュボードを起動します...");

    // ターミナルセットアップ
    enable_raw_mode()?;
    let mut stdout = stdout();
    execute!(stdout, EnterAlternateScreen)?;
    let backend = CrosstermBackend::new(stdout);
    let mut terminal = Terminal::new(backend)?;

    // アプリ初期化
    let mut app = App::new();

    // メインループ
    let result = run_app(&mut terminal, &mut app, args.interval);

    // ターミナルクリーンアップ
    disable_raw_mode()?;
    execute!(terminal.backend_mut(), LeaveAlternateScreen)?;
    terminal.show_cursor()?;

    result
}

fn run_app(
    terminal: &mut Terminal<CrosstermBackend<Stdout>>,
    app: &mut App,
    interval_secs: u64,
) -> Result<()> {
    let timeout = Duration::from_millis(100);
    let update_interval = Duration::from_secs(interval_secs);
    let mut last_update = std::time::Instant::now();

    loop {
        // 画面描画
        terminal.draw(|f| app.render(f))?;

        // イベント処理
        if let Some(event) = EventHandler::read_event(timeout)? {
            app.handle_event(event)?;
        }

        // 終了チェック
        if app.should_quit() {
            break;
        }

        // 定期更新
        if last_update.elapsed() >= update_interval {
            app.update();
            last_update = std::time::Instant::now();
        }
    }

    Ok(())
}
```

### 2. cli/src/commands/mod.rs の更新
```rust
pub mod init;
pub mod spec;
pub mod tasks;
pub mod style;
pub mod worktree;
pub mod monitor; // 追加

pub use init::execute as init_execute;
pub use spec::execute as spec_execute;
pub use tasks::execute as tasks_execute;
pub use style::execute as style_execute;
pub use worktree::execute as worktree_execute;
pub use monitor::execute as monitor_execute; // 追加
```

### 3. cli/src/main.rs の更新
```rust
use clap::{Parser, Subcommand};

#[derive(Debug, Parser)]
#[command(name = "aad")]
#[command(about = "AI-DLC - AI駆動開発ライフサイクルツール", long_about = None)]
struct Cli {
    #[command(subcommand)]
    command: Commands,
}

#[derive(Debug, Subcommand)]
enum Commands {
    Init(commands::init::InitArgs),
    Spec(commands::spec::SpecArgs),
    Tasks(commands::tasks::TasksArgs),
    Style(commands::style::StyleArgs),
    Worktree(commands::worktree::WorktreeArgs),
    Monitor(commands::monitor::MonitorArgs), // 追加
}

fn main() -> anyhow::Result<()> {
    let cli = Cli::parse();

    match cli.command {
        Commands::Init(args) => commands::init_execute(args),
        Commands::Spec(args) => commands::spec_execute(args),
        Commands::Tasks(args) => commands::tasks_execute(args),
        Commands::Style(args) => commands::style_execute(args),
        Commands::Worktree(args) => commands::worktree_execute(args),
        Commands::Monitor(args) => commands::monitor_execute(args), // 追加
    }
}
```

### 4. cli/Cargo.toml の更新
```toml
[dependencies]
# ... 既存の依存 ...
tui = { path = "../tui" }
```

### 5. App::update() の実装
`tui/src/app.rs` の `update()` メソッドを実装:
```rust
impl App {
    /// 状態を更新
    pub fn update(&mut self) {
        // TODO: 実際のセッションデータを取得
        // 現段階ではダミーデータで問題なし
    }
}
```

---

## 変更ファイル

- `crates/cli/src/commands/monitor.rs` - 新規作成
- `crates/cli/src/commands/mod.rs` - monitor モジュール追加
- `crates/cli/src/main.rs` - Monitor サブコマンド追加
- `crates/cli/Cargo.toml` - tui 依存追加
- `crates/tui/src/app.rs` - update() 実装

---

## 受け入れ基準

### AC-6.1: `cli/src/commands/monitor.rs` が実装されている
```bash
test -f crates/cli/src/commands/monitor.rs
```

### AC-6.2: `aad monitor` 実行で TUI が起動する
```bash
cargo run -p cli -- monitor --help | grep "更新間隔"
```

### AC-6.3: 1秒ごとにセッション状態が更新される
```bash
grep "update_interval" crates/cli/src/commands/monitor.rs
```

### AC-6.4: リアルタイムで進捗が反映される
```bash
grep "app.update()" crates/cli/src/commands/monitor.rs
```

### AC-6.5: `Ctrl+C` または `q` キーで正常終了できる
```bash
grep "disable_raw_mode" crates/cli/src/commands/monitor.rs
grep "LeaveAlternateScreen" crates/cli/src/commands/monitor.rs
```

---

## テストコマンド

```bash
# ビルド確認
cargo build -p cli

# monitor コマンドのヘルプ表示
cargo run -p cli -- monitor --help

# 手動起動テスト（終了は q キー）
cargo run -p cli -- monitor

# Lintチェック
cargo clippy -p cli -- -D warnings
```

---

## 期待結果

| チェック項目 | 期待結果 |
|-------------|----------|
| コマンド実装 | aad monitor が動作する |
| TUI起動 | ダッシュボードが表示される |
| 終了処理 | 正常にクリーンアップされる |

---

## 備考

- 更新間隔は `--interval` オプションで変更可能（デフォルト: 1秒）
- Ctrl+C でも正常終了できるようにする
- ターミナルのクリーンアップは必ず行う（ユーザー体験重視）
- 現段階では実際のセッションデータ取得は未実装（ダミーデータで問題なし）
