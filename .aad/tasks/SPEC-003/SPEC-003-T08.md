# SPEC-003-T08: worktree コマンド実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-003-T08 |
| SPEC | SPEC-003 |
| 複雑度 | M（4-8時間） |
| 優先度 | Must |
| 依存 | T02, T03 |
| 担当 | 未アサイン |

---

## 概要

`aad worktree <spec-id>` で Git worktree とブランチを作成する。`../aad-SPEC-XXX/` に worktree を配置し、ブランチ名は `feature/SPEC-XXX` とする。

---

## 作業内容

### 1. worktree コマンドハンドラ作成
```rust
// crates/cli/src/commands/worktree.rs
use std::path::Path;
use std::process::Command;

pub fn execute(spec_id: &str) -> anyhow::Result<()> {
    // 1. Git リポジトリチェック
    if !Path::new(".git").exists() {
        anyhow::bail!("エラー: Git リポジトリではありません");
    }

    let worktree_path = format!("../aad-{}", spec_id);
    let branch_name = format!("feature/{}", spec_id);

    // 2. 既存 worktree チェック
    if Path::new(&worktree_path).exists() {
        anyhow::bail!(
            "エラー: worktree '{}' は既に存在します",
            worktree_path
        );
    }

    println!("Git worktree を作成しています...\n");

    // 3. ブランチ作成
    let create_branch = Command::new("git")
        .args(&["checkout", "-b", &branch_name])
        .output()?;

    if !create_branch.status.success() {
        // ブランチが既に存在する場合はチェックアウト
        Command::new("git")
            .args(&["checkout", &branch_name])
            .output()?;
    }

    println!("✓ ブランチ '{}' を作成しました", branch_name);

    // 4. worktree 作成
    let worktree_output = Command::new("git")
        .args(&["worktree", "add", &worktree_path, &branch_name])
        .output()?;

    if !worktree_output.status.success() {
        let error = String::from_utf8_lossy(&worktree_output.stderr);
        anyhow::bail!("worktree 作成に失敗しました: {}", error);
    }

    println!("✓ worktree '{}' を作成しました", worktree_path);

    // 5. 元のブランチに戻る
    Command::new("git")
        .args(&["checkout", "-"])
        .output()?;

    println!("\n✅ worktree 作成が完了しました");
    println!("\n次のステップ:");
    println!("  cd {}", worktree_path);

    Ok(())
}
```

### 2. main.rs に統合
```rust
Commands::Worktree { spec_id } => commands::worktree::execute(&spec_id)?,
```

---

## 変更ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `crates/cli/src/commands/worktree.rs` | 新規 | worktree コマンド実装 |
| `crates/cli/src/commands/mod.rs` | 変更 | worktree モジュール追加 |
| `crates/cli/src/main.rs` | 変更 | worktree コマンド呼び出し |

---

## 受け入れ基準

- [ ] AC-8.1: `aad worktree SPEC-001` 実行後、`../aad-SPEC-001/` に worktree が作成される
- [ ] AC-8.2: ブランチ名が `feature/SPEC-001` となる
- [ ] AC-8.3: Git リポジトリでない場合はエラーメッセージが表示される
- [ ] AC-8.4: 既存の worktree がある場合は上書き確認が表示される

---

## テストコマンド

```bash
# worktree コマンド実行
cargo run -p cli -- worktree SPEC-999

# 確認
git worktree list
git branch

# worktree に移動
cd ../aad-SPEC-999
git status

# クリーンアップ
cd ../claude-code-aad
git worktree remove ../aad-SPEC-999
git branch -D feature/SPEC-999
```

---

## 期待結果

```
Git worktree を作成しています...

✓ ブランチ 'feature/SPEC-999' を作成しました
✓ worktree '../aad-SPEC-999' を作成しました

✅ worktree 作成が完了しました

次のステップ:
  cd ../aad-SPEC-999
```

---

## 備考

- Git コマンドは std::process::Command を使用
- エラーハンドリングを適切に実装
- worktree 作成後は元のブランチに戻る
