# SPEC-003-T04: init コマンド実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-003-T04 |
| SPEC | SPEC-003 |
| 複雑度 | M（4-8時間） |
| 優先度 | Must |
| 依存 | T02, T03 |
| 担当 | 未アサイン |

---

## 概要

`aad init` でプロジェクトを初期化し、`.aad/` ディレクトリとテンプレートファイルを配置する。既存プロジェクトでは上書き確認を表示する。

---

## 作業内容

### 1. init コマンドハンドラ作成
```rust
// crates/cli/src/commands/init.rs
use std::fs;
use std::path::Path;

pub fn execute() -> anyhow::Result<()> {
    println!("プロジェクトを初期化しています...\n");

    // 1. .aad/ ディレクトリ作成
    create_directory(".aad")?;
    create_directory(".aad/specs")?;
    create_directory(".aad/tasks")?;
    create_directory(".aad/sessions")?;
    create_directory(".aad/retrospectives")?;
    create_directory(".aad/progress")?;
    println!("✓ .aad/ ディレクトリを作成しました");

    // 2. config/ ディレクトリとテンプレート作成
    create_directory("config")?;

    create_template_file(
        "config/aad.toml",
        include_str!("../../templates/aad.toml"),
    )?;

    create_template_file(
        "config/styles.toml",
        include_str!("../../templates/styles.toml"),
    )?;
    println!("✓ テンプレートファイルを配置しました");

    // 3. CLAUDE.md 作成（存在しない場合）
    if !Path::new("CLAUDE.md").exists() {
        create_template_file(
            "CLAUDE.md",
            include_str!("../../templates/CLAUDE.md"),
        )?;
        println!("✓ CLAUDE.md を作成しました");
    } else {
        println!("⚠ CLAUDE.md は既に存在します（スキップ）");
    }

    println!("\n✅ プロジェクトの初期化が完了しました");
    Ok(())
}

fn create_directory(path: &str) -> anyhow::Result<()> {
    if !Path::new(path).exists() {
        fs::create_dir_all(path)?;
    }
    Ok(())
}

fn create_template_file(path: &str, content: &str) -> anyhow::Result<()> {
    if Path::new(path).exists() {
        print!("ファイル '{}' は既に存在します。上書きしますか? [y/N]: ", path);
        use std::io::{self, Write};
        io::stdout().flush()?;

        let mut input = String::new();
        io::stdin().read_line(&mut input)?;

        if !input.trim().eq_ignore_ascii_case("y") {
            println!("スキップしました");
            return Ok(());
        }
    }

    fs::write(path, content)?;
    Ok(())
}
```

### 2. テンプレートファイル作成
```toml
# crates/cli/templates/aad.toml
version = "1.0"
context_threshold = 70
default_branch = "main"

[workflow]
phases = ["SPEC", "TASKS", "TDD", "REVIEW", "RETRO", "MERGE"]
auto_transition = false
```

```toml
# crates/cli/templates/styles.toml
[styles.standard]
description = "標準的な出力スタイル"

[styles.standard.tokens]
role = "開発者"
tone = "丁寧"

[styles.sage]
description = "賢者スタイル"

[styles.sage.tokens]
role = "賢者"
tone = "落ち着いた"
```

```markdown
# crates/cli/templates/CLAUDE.md
# プロジェクト指示書

このファイルはClaude Codeへの指示書です。

## プロジェクト概要

**プロジェクト名**:
**目的**:
```

### 3. main.rs に統合
```rust
match cli.command {
    Commands::Init => commands::init::execute()?,
    // ...
}
```

---

## 変更ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `crates/cli/src/commands/init.rs` | 新規 | init コマンド実装 |
| `crates/cli/src/commands/mod.rs` | 変更 | init モジュール追加 |
| `crates/cli/templates/aad.toml` | 新規 | テンプレート |
| `crates/cli/templates/styles.toml` | 新規 | テンプレート |
| `crates/cli/templates/CLAUDE.md` | 新規 | テンプレート |
| `crates/cli/src/main.rs` | 変更 | init コマンド呼び出し |

---

## 受け入れ基準

- [ ] AC-4.1: `aad init` 実行後、`.aad/` ディレクトリが作成される
- [ ] AC-4.2: `.aad/specs/`, `.aad/sessions/`, `.aad/retrospectives/` ディレクトリが作成される
- [ ] AC-4.3: `config/aad.toml` と `config/styles.toml` のテンプレートが配置される
- [ ] AC-4.4: 既存のプロジェクトでは上書き確認が表示される
- [ ] AC-4.5: 成功メッセージが日本語で表示される

---

## テストコマンド

```bash
# 一時ディレクトリでテスト
cd /tmp
mkdir test-project && cd test-project
git init

# init コマンド実行
cargo run -p cli -- init

# ディレクトリ構造確認
tree .aad
ls config/
```

---

## 期待結果

```
プロジェクトを初期化しています...

✓ .aad/ ディレクトリを作成しました
✓ テンプレートファイルを配置しました
✓ CLAUDE.md を作成しました

✅ プロジェクトの初期化が完了しました
```

---

## 備考

- テンプレートは `include_str!` マクロでバイナリに埋め込む
- 上書き確認はインタラクティブ（stdin 使用）
