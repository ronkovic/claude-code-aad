# SPEC-003-T03: DI コンテナ実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-003-T03 |
| SPEC | SPEC-003 |
| 複雑度 | M（4-8時間） |
| 優先度 | Must |
| 依存 | T01 |
| 担当 | 未アサイン |

---

## 概要

依存性注入の仕組みを構築し、リポジトリ実装を切り替え可能にする。テスト時にモックリポジトリへの切り替えが可能である。

---

## 作業内容

### 1. App 構造体定義
```rust
// crates/cli/src/app.rs
use application::workflow::transition;
use domain::repositories::{SpecRepository, TaskRepository, SessionRepository};
use infrastructure::config::AadConfig;
use std::sync::Arc;

pub struct App {
    spec_repository: Arc<dyn SpecRepository>,
    task_repository: Arc<dyn TaskRepository>,
    session_repository: Arc<dyn SessionRepository>,
    config: AadConfig,
}

impl App {
    /// デフォルトの依存関係で App を作成
    pub fn new() -> anyhow::Result<Self> {
        // TODO: 実際のリポジトリ実装をインスタンス化（SPEC-004で実装予定）
        let config = AadConfig::default();

        Ok(Self {
            spec_repository: todo!("FileSpecRepository の実装待ち"),
            task_repository: todo!("FileTaskRepository の実装待ち"),
            session_repository: todo!("FileSessionRepository の実装待ち"),
            config,
        })
    }

    /// テスト用にモックリポジトリを注入
    #[cfg(test)]
    pub fn with_repositories(
        spec_repository: Arc<dyn SpecRepository>,
        task_repository: Arc<dyn TaskRepository>,
        session_repository: Arc<dyn SessionRepository>,
        config: AadConfig,
    ) -> Self {
        Self {
            spec_repository,
            task_repository,
            session_repository,
            config,
        }
    }

    pub fn spec_repository(&self) -> &dyn SpecRepository {
        &*self.spec_repository
    }

    pub fn task_repository(&self) -> &dyn TaskRepository {
        &*self.task_repository
    }

    pub fn session_repository(&self) -> &dyn SessionRepository {
        &*self.session_repository
    }

    pub fn config(&self) -> &AadConfig {
        &self.config
    }
}
```

### 2. main.rs に App 統合
```rust
mod app;
mod commands;

use app::App;
use clap::Parser;
use commands::Commands;

#[derive(Parser)]
#[command(name = "aad")]
#[command(version, about = "AI駆動開発ツール", long_about = None)]
struct Cli {
    #[command(subcommand)]
    command: Commands,
}

fn main() -> anyhow::Result<()> {
    let cli = Cli::parse();
    let app = App::new()?;

    match cli.command {
        // TODO: app を使用したコマンド実装
        _ => unimplemented!(),
    }

    Ok(())
}
```

### 3. テスト用モック作成
```rust
// crates/cli/src/app.rs (tests モジュール)
#[cfg(test)]
mod tests {
    use super::*;
    use domain::entities::Spec;
    use domain::value_objects::SpecId;
    use async_trait::async_trait;

    struct MockSpecRepository;

    #[async_trait]
    impl SpecRepository for MockSpecRepository {
        async fn find_by_id(&self, id: &SpecId) -> domain::error::Result<Option<Spec>> {
            // モック実装
            Ok(None)
        }

        // 他のメソッドも実装...
    }

    #[test]
    fn test_app_with_mock() {
        let spec_repo = Arc::new(MockSpecRepository);
        // 他のモックも作成...

        let app = App::with_repositories(
            spec_repo,
            task_repo,
            session_repo,
            AadConfig::default(),
        );

        // App がモックリポジトリを使用できることを確認
        assert!(app.spec_repository() is not null);
    }
}
```

---

## 変更ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `crates/cli/src/app.rs` | 新規 | DI コンテナ |
| `crates/cli/src/main.rs` | 変更 | App 統合 |
| `crates/cli/Cargo.toml` | 変更 | async-trait 依存追加 |

---

## 受け入れ基準

- [ ] AC-3.1: `cli/src/app.rs` に `App` 構造体が定義されている
- [ ] AC-3.2: `App::new()` でリポジトリ実装が注入される
- [ ] AC-3.3: テスト時にモックリポジトリへの切り替えが可能である
- [ ] AC-3.4: `App::run()` メソッドでコマンド実行が行われる

---

## テストコマンド

```bash
# ビルド確認
cargo build -p cli

# テスト実行
cargo test -p cli app::tests
```

---

## 備考

- リポジトリの具象実装は SPEC-004 で実装予定
- この段階では `todo!()` マクロでプレースホルダーを残す
- テスト用モックは最小限の実装でOK
