# SPEC-002-T05: ワークフロー状態遷移ロジック実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-002-T05 |
| SPEC | SPEC-002 |
| 複雑度 | S（1-4時間） |
| 優先度 | Must |
| 依存 | T01 |
| 担当 | 未アサイン |

---

## 概要

Phase 間の状態遷移ルールを実装し、不正な遷移を防ぐ。正当な遷移（SPEC → TASKS → TDD → REVIEW → RETRO → MERGE）のみを許可する。

---

## 作業内容

### 1. 遷移ロジック実装
```rust
// application/src/workflow/transition.rs

/// 状態遷移が可能かチェック
pub fn can_transition(from: Phase, to: Phase) -> bool {
    match (from, to) {
        (Phase::Spec, Phase::Tasks) => true,
        (Phase::Tasks, Phase::Tdd) => true,
        (Phase::Tdd, Phase::Review) => true,
        (Phase::Review, Phase::Retro) => true,
        (Phase::Retro, Phase::Merge) => true,
        _ => false,
    }
}

/// 次のフェーズを取得
pub fn next_phase(current: Phase) -> Option<Phase> {
    current.next()  // Domain層の実装を活用
}

/// フェーズ遷移を実行
pub fn transition(workflow: &mut Workflow, to: Phase) -> Result<(), TransitionError>;
```

### 2. エラー型定義
```rust
#[derive(Debug, Error)]
pub enum TransitionError {
    #[error("不正なフェーズ遷移: {from} → {to}")]
    InvalidTransition { from: Phase, to: Phase },

    #[error("フェーズ {phase} はまだ承認されていません")]
    NotApproved { phase: Phase },
}
```

### 3. モジュール構成
```
crates/application/src/workflow/
├── mod.rs
├── transition.rs     # 遷移ロジック
└── error.rs          # ワークフローエラー
```

---

## 変更ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `crates/application/src/workflow/mod.rs` | 変更 | transition モジュールを追加 |
| `crates/application/src/workflow/transition.rs` | 新規 | 遷移ロジック実装 |
| `crates/application/src/workflow/error.rs` | 新規 | エラー型定義 |

---

## 受け入れ基準

- [ ] AC-5.1: `application/src/workflow/transition.rs` に遷移ロジックが実装されている
- [ ] AC-5.2: 正当な遷移（SPEC → TASKS → TDD → REVIEW → RETRO → MERGE）が許可される
- [ ] AC-5.3: 不正な遷移（例: SPEC → REVIEW）が拒否される
- [ ] AC-5.4: `can_transition(from: Phase, to: Phase) -> bool` メソッドが実装されている
- [ ] AC-5.5: `next_phase(current: Phase) -> Option<Phase>` メソッドが実装されている

---

## テスト項目

| テスト | 内容 | 期待結果 |
|--------|------|----------|
| test_valid_transitions | 正当な遷移をテスト | すべてtrue |
| test_invalid_transitions | 不正な遷移をテスト | すべてfalse |
| test_next_phase | 次フェーズ取得 | 正しいフェーズを返す |
| test_next_phase_merge | MERGEの次 | None |
| test_transition_without_approval | 未承認での遷移 | エラー |
| test_transition_success | 承認後の遷移 | 成功 |

---

## テストコマンド

```bash
# テスト実行
cargo test -p application workflow

# 全テスト
cargo test --all
```

---

## 備考

- Domain層の `Workflow` エンティティと `Phase` を活用
- T03, T04 と並列実行可能
