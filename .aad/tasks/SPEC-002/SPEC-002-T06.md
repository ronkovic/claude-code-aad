# SPEC-002-T06: バリデーション実装

## 基本情報

| 項目 | 内容 |
|------|------|
| タスクID | SPEC-002-T06 |
| SPEC | SPEC-002 |
| 複雑度 | M（4-8時間） |
| 優先度 | Must |
| 依存 | T03, T04 |
| 担当 | 未アサイン |

---

## 概要

設定ファイル読み込み時に、必須フィールドの欠落、数値範囲、パス指定の妥当性をチェックする。日本語でユーザーフレンドリーなエラーメッセージを表示する。

---

## 作業内容

### 1. バリデーショントレイト定義
```rust
pub trait Validate {
    fn validate(&self) -> Result<(), ValidationError>;
}
```

### 2. AadConfig バリデーション
- `version` フィールドの必須チェック
- `context_threshold` の範囲チェック（0-100）
- `workflow.phases` の空チェック

### 3. StyleConfig バリデーション
- スタイル名の形式チェック
- トークンマップの循環参照チェック（Domain層を活用）
- トークン名の重複チェック

### 4. エラーメッセージの日本語化
```rust
#[derive(Debug, Error)]
pub enum ValidationError {
    #[error("必須フィールド '{field}' が設定されていません")]
    MissingField { field: String },

    #[error("'{field}' の値 {value} は範囲外です（{min}〜{max}）")]
    OutOfRange { field: String, value: i64, min: i64, max: i64 },

    #[error("パス '{path}' が見つかりません")]
    PathNotFound { path: String },

    #[error("設定ファイル '{file}' の読み込みに失敗しました: {reason}")]
    FileReadError { file: String, reason: String },
}
```

---

## 変更ファイル

| ファイル | 操作 | 説明 |
|----------|------|------|
| `crates/infrastructure/src/config/mod.rs` | 変更 | validation モジュールを追加 |
| `crates/infrastructure/src/config/validation.rs` | 新規 | バリデーションロジック |
| `crates/infrastructure/src/config/aad_config.rs` | 変更 | Validate 実装を追加 |
| `crates/infrastructure/src/config/style_config.rs` | 変更 | Validate 実装を追加 |

---

## 受け入れ基準

- [ ] AC-6.1: 必須フィールドが欠落している場合にエラーメッセージを表示する
- [ ] AC-6.2: 数値範囲のバリデーションが実装されている（例: `context_threshold` が 0-100 の範囲内）
- [ ] AC-6.3: パス指定のバリデーションが実装されている
- [ ] AC-6.4: エラーメッセージが日本語でユーザーフレンドリーである

---

## テスト項目

| テスト | 内容 | 期待結果 |
|--------|------|----------|
| test_validation_missing_version | versionフィールド欠落 | 日本語エラーメッセージ |
| test_validation_threshold_too_high | threshold > 100 | 範囲エラー |
| test_validation_threshold_negative | threshold < 0 | 範囲エラー |
| test_validation_empty_phases | phases が空 | エラー |
| test_validation_invalid_path | 存在しないパス | パスエラー |
| test_validation_duplicate_token | トークン名重複 | 警告またはエラー |
| test_validation_success | 正常な設定 | Ok(()) |

---

## テストコマンド

```bash
# テスト実行
cargo test -p infrastructure validation

# 全テスト
cargo test --all
```

---

## 備考

- 日本語エラーメッセージはCLAUDE.mdの言語設定に従う
- セキュリティ: パスインジェクション対策を含む
