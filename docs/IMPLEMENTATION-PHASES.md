# 実装フェーズ詳細

このドキュメントは、claude-code-aad v2 の完成までの実装フェーズを詳細に整理したものです。

## 概要

全8フェーズ、約10週間で v2 をリリース予定。各フェーズは独立して完結し、段階的に機能を追加していきます。

---

## Phase 1: プロジェクト構造 + Domain基盤

**期間**: 1週間

### 目標

Rust ワークスペースと Domain 層の基盤を構築する。クリーンアーキテクチャの中核となるドメインモデルを定義し、ビジネスロジックの基盤を整備する。

### 成果物

- `Cargo.toml` (ワークスペース定義)
- `crates/domain/` クレート
- ドメインエンティティとバリューオブジェクト
- リポジトリトレイト定義

### タスク一覧

1. **Rust ワークスペース初期化**
   - ルート `Cargo.toml` 作成
   - ワークスペースメンバー定義

2. **domain クレート作成**
   - `crates/domain/` ディレクトリ作成
   - `Cargo.toml` 設定

3. **Entities 実装**
   - `Spec`: 仕様エンティティ
   - `Task`: タスクエンティティ
   - `Session`: セッションエンティティ
   - `Workflow`: ワークフローエンティティ
   - `Style`: スタイルエンティティ

4. **Value Objects 実装**
   - `SpecId`, `TaskId`: ID型
   - `Phase`: フェーズ列挙型（SPEC, TASKS, TDD, REVIEW, RETRO, MERGE）
   - `Status`: ステータス列挙型（pending, in_progress, done, failed）
   - `Priority`: 優先度列挙型（Must, Should, Could, Won't）
   - `StyleName`: スタイル名
   - `TokenMap`: トークンマッピング

5. **Repository トレイト定義**
   - `SpecRepository`
   - `TaskRepository`
   - `SessionRepository`

6. **単体テスト作成**
   - エンティティの振る舞いテスト
   - バリューオブジェクトのバリデーションテスト

### 完了条件

- ✅ `cargo build` が成功
- ✅ `cargo test` が全て pass
- ✅ ドメインモデルが定義済み
- ✅ リポジトリトレイトが定義済み

### 依存関係

なし（最初のフェーズ）

---

## Phase 2: 設定管理 + ワークフロー

**期間**: 1週間

### 目標

TOML 設定ファイルの読み込みとワークフロー定義を実装する。スタイルシステムの設定パーサーも含む。

### 成果物

- `config/aad.toml` パーサー
- `config/styles.toml` パーサー
- Phase 状態遷移ロジック
- `application` クレート

### タスク一覧

1. **application クレート作成**
   - `crates/application/` ディレクトリ作成
   - ユースケース層の基盤構築

2. **infrastructure/config 実装**
   - `crates/infrastructure/` クレート作成
   - TOML パーサー実装

3. **AadConfig 構造体実装**
   - `config/aad.toml` の読み込み
   - デフォルト値の設定
   - バリデーション

4. **StyleConfig 構造体実装**
   - `config/styles.toml` の読み込み
   - スタイル定義のパース
   - TokenMap の構築

5. **ワークフロー状態遷移ロジック**
   - Phase 遷移ルールの実装
   - 状態検証ロジック
   - 遷移可否の判定

6. **バリデーション実装**
   - 設定値の妥当性チェック
   - 必須フィールドの検証
   - エラーメッセージの整備

### 完了条件

- ✅ 設定ファイルの読み込みが動作
- ✅ ワークフロー遷移が正しく機能
- ✅ スタイル設定が正しくパース可能
- ✅ バリデーションエラーが適切に表示

### 依存関係

- Phase 1 完了（Domain層が必要）

---

## Phase 3: CLI 基本コマンド

**期間**: 1週間

### 目標

基本的な CLI コマンドを実装し、ユーザーがコマンドラインから操作できるようにする。

### 成果物

- `cli` クレート
- `aad init` コマンド
- `aad spec` コマンド
- `aad tasks` コマンド
- `aad style` コマンド
- `aad worktree` コマンド

### タスク一覧

1. **cli クレート作成**
   - `crates/cli/` ディレクトリ作成
   - `clap` による CLI 基盤構築

2. **clap によるコマンド定義**
   - サブコマンド構造の設計
   - 引数・オプションの定義
   - ヘルプメッセージの整備

3. **DI コンテナ (app.rs) 実装**
   - 依存性注入の仕組み構築
   - リポジトリ実装の切り替え可能化

4. **init コマンド実装**
   - プロジェクト初期化
   - `.aad/` ディレクトリ作成
   - テンプレートファイルの配置

5. **spec コマンド実装**
   - 仕様ファイルの作成
   - 受け入れ基準のテンプレート
   - MoSCoW 優先度設定

6. **tasks コマンド実装**
   - タスク分割
   - タスクID自動採番
   - GitHub Issues 作成（オプション）

7. **style コマンド実装**
   - スタイル一覧表示
   - スタイル切替
   - トークン適用

8. **worktree コマンド実装**
   - Git worktree 作成
   - ブランチ作成

### 完了条件

- ✅ `aad --help` が表示
- ✅ 各コマンドが基本動作
- ✅ エラーハンドリングが適切
- ✅ ユーザーフィードバックが明確

### 依存関係

- Phase 1, 2 完了（Domain + Config 層が必要）

---

## Phase 4: オーケストレーション

**期間**: 2週間

### 目標

3層オーケストレーターの実装により、複数の Spec を並列実行し、自動エスカレーションを実現する。

### 成果物

- `Orchestrator` サービス
- `ChildSession` 管理機構
- `aad orchestrate` コマンド
- エスカレーション機能

### タスク一覧

1. **Orchestrator 構造体実装**
   - オーケストレーター本体の構築
   - セッション管理データ構造

2. **セッション登録・起動ロジック**
   - Spec の登録
   - Child Session の起動
   - 実行順序の制御

3. **モニターループ実装**
   - 定期的な状態チェック
   - セッション進捗の監視
   - タイムアウト処理

4. **エスカレーション処理**
   - 失敗検出ロジック
   - 親セッションへの通知
   - エスカレーションログ記録

5. **完了・失敗ハンドリング**
   - 正常完了時の処理
   - 異常終了時のロールバック
   - リトライ機構

6. **orchestrate コマンド実装**
   - コマンドライン引数の処理
   - オーケストレーターの起動

7. **--resume, --dry-run オプション**
   - 再開機能
   - ドライラン（検証モード）

### 完了条件

- ✅ 複数 Spec の並列実行が可能
- ✅ エスカレーションが正しく動作
- ✅ 失敗時のリカバリーが機能
- ✅ ドライランで実行計画が確認可能

### 依存関係

- Phase 1, 2, 3 完了（Domain + Config + CLI が必要）

---

## Phase 5: セッション管理 + 永続化

**期間**: 1週間

### 目標

セッション状態の永続化とスタイル管理を実装し、処理の中断・再開を可能にする。

### 成果物

- JSON Repository 実装
- スタイル状態永続化
- バックアップ機能
- `aad persist` コマンド

### タスク一覧

1. **persistence/ 実装**
   - `infrastructure/persistence/` モジュール作成
   - JSON ファイル I/O 基盤

2. **SpecJsonRepo, TaskJsonRepo, SessionJsonRepo**
   - 各リポジトリの具象実装
   - CRUD 操作の実装

3. **StyleFileAdapter 実装**
   - CLAUDE.md へのスタイル書き込み
   - マーカー検出と置換

4. **TokenReplacer 実装（マーカー方式）**
   - `<!-- AAD_STYLE:BEGIN -->` ... `<!-- AAD_STYLE:END -->` 検出
   - トークン置換ロジック
   - 既存内容の保護

5. **BackupAdapter 実装**
   - ファイルバックアップ
   - `.aad/backups/` への保存
   - タイムスタンプ付きバックアップ

6. **persist save/restore コマンド**
   - 現在状態の保存
   - 過去状態の復元

### 完了条件

- ✅ セッション状態が保存・復元可能
- ✅ スタイル切替が動作
- ✅ バックアップが正しく作成される
- ✅ データ整合性が保たれる

### 依存関係

- Phase 1, 2 完了（Domain + Config 層が必要）

---

## Phase 6: TUI ダッシュボード

**期間**: 2週間

### 目標

Ratatui によるリアルタイムダッシュボードを実装し、視覚的に進捗を把握できるようにする。

### 成果物

- `tui` クレート
- ダッシュボード画面
- 監視画面
- `aad monitor` コマンド

### タスク一覧

1. **tui クレート作成**
   - `crates/tui/` ディレクトリ作成
   - Ratatui の導入

2. **App 構造体・状態管理**
   - アプリケーション状態の定義
   - 画面遷移ロジック

3. **Widgets 実装**
   - `SessionList`: セッション一覧
   - `TaskProgress`: タスク進捗バー
   - `SpecTree`: Spec ツリー表示
   - `ContextBar`: コンテキスト使用率
   - `PhaseIndicator`: 現在のフェーズ表示

4. **Views 実装**
   - `Dashboard`: メイン画面
   - `Monitor`: 監視画面
   - `Workflow`: ワークフロー画面
   - `Detail`: 詳細画面

5. **キーボードイベント処理**
   - キーバインディング定義
   - イベントループ実装

6. **monitor コマンド連携**
   - TUI の起動
   - データの定期更新

### 完了条件

- ✅ `aad monitor` でダッシュボード起動
- ✅ リアルタイム更新が動作
- ✅ キーボード操作が快適
- ✅ UI が見やすく整理されている

### 依存関係

- Phase 1, 2, 3, 4, 5 完了（全基盤が必要）

---

## Phase 7: タスクループ + 完了検出

**期間**: 1週間

### 目標

ralph-tui 相当のタスクループ機能を実装し、タスクの自動進行を実現する。

### 成果物

- `LoopEngine` サービス
- `CompletionDetector`
- `aad loop` コマンド
- `completion-patterns.json` 設定

### タスク一覧

1. **LoopEngine 実装**
   - タスクループのメインロジック
   - タスクキューの管理

2. **完了パターン検出（completion-patterns.json）**
   - パターン定義の読み込み
   - 正規表現マッチング
   - 完了判定ロジック

3. **自動次タスク進行**
   - 完了検出後の次タスク選択
   - 依存関係の考慮
   - スキップ・リトライ処理

4. **loop コマンド実装**
   - ループ開始・停止
   - 中断・再開

5. **ループ状態の可視化**
   - TUI への統合
   - 進捗表示

### 完了条件

- ✅ タスクループが自動進行
- ✅ 完了検出が正しく動作
- ✅ 依存関係が考慮される
- ✅ エラー時の中断が適切

### 依存関係

- Phase 1, 2, 3, 4, 5 完了（セッション管理が必要）

---

## Phase 8: 品質ゲート + GitHub連携

**期間**: 1週間

### 目標

品質チェックと GitHub PR 連携を実装し、完全な自動化を実現する。

### 成果物

- `QualityService`
- `GhCliAdapter` (GitHub CLI ラッパー)
- `aad gate` コマンド
- `aad integrate` コマンド
- `aad retro` コマンド
- CI/CD 設定

### タスク一覧

1. **QualityService 実装**
   - 品質チェックロジック
   - フェーズごとのゲート条件

2. **gate コマンド実装**
   - 品質ゲートの実行
   - チェック結果の表示
   - 承認待ち機能

3. **GhCliAdapter 実装**
   - `gh` コマンドのラッパー
   - PR 作成・マージ
   - Issue 操作

4. **integrate コマンド (PR 作成)**
   - Draft PR の作成
   - レビュー依頼
   - CI ステータスの確認

5. **retro コマンド実装**
   - 振り返りログの作成
   - `.aad/retrospectives/` への保存
   - CLAUDE.md 更新提案

6. **CI/CD 設定 (.github/workflows)**
   - GitHub Actions ワークフロー定義
   - 自動テスト実行
   - 品質チェック自動化

### 完了条件

- ✅ 品質ゲートが全フェーズで動作
- ✅ PR 作成・マージが自動化
- ✅ CI/CD が正しく動作
- ✅ 振り返りログが記録される

### 依存関係

- Phase 1-7 完了（全機能が必要）

---

## マイルストーン

| マイルストーン | Phase | 主要成果物 | 期間 |
|---------------|-------|-----------|------|
| **M1: 基盤完成** | 1-2 | Domain + Config | 2週間 |
| **M2: CLI動作** | 3 | 基本コマンド | 1週間 |
| **M3: オーケストレーション** | 4 | 自動実行 | 2週間 |
| **M4: 永続化** | 5 | 状態保存 | 1週間 |
| **M5: TUI完成** | 6 | ダッシュボード | 2週間 |
| **M6: ループ動作** | 7 | 自動タスク進行 | 1週間 |
| **M7: v2リリース** | 8 | 全機能完成 | 1週間 |

**合計期間**: 約10週間（2.5ヶ月）

---

## 検証方法

各フェーズ完了時に以下を確認：

### コード品質

```bash
# ビルド確認
cargo build --all

# テスト実行
cargo test --all

# Lint確認
cargo clippy --all

# フォーマット確認
cargo fmt --all -- --check
```

### 機能確認

各フェーズごとに該当コマンドの動作確認を実施：

- **Phase 1-2**: ユニットテストのみ
- **Phase 3**: `aad init`, `aad spec`, `aad tasks`, `aad style`, `aad worktree` の動作確認
- **Phase 4**: `aad orchestrate` で複数Spec の並列実行確認
- **Phase 5**: `aad persist save/restore` で状態保存・復元確認
- **Phase 6**: `aad monitor` でダッシュボード表示確認
- **Phase 7**: `aad loop` でタスク自動進行確認
- **Phase 8**: `aad gate`, `aad integrate`, `aad retro` の動作確認

### 統合テスト

Phase 8 完了後、以下のエンドツーエンドテストを実施：

1. `aad init` でプロジェクト初期化
2. `aad spec` で仕様作成
3. `aad tasks` でタスク分割
4. `aad orchestrate` で自動実行
5. `aad monitor` で進捗確認
6. `aad gate` で品質チェック
7. `aad integrate` で PR 作成
8. `aad retro` で振り返り

---

## リスク管理

### 技術的リスク

| リスク | 対策 |
|--------|------|
| Ratatui の学習コスト | 早期に Phase 6 のプロトタイプ作成 |
| GitHub CLI の互換性 | `gh` のバージョン固定と CI での検証 |
| 並列実行の複雑性 | Phase 4 で十分なテスト |

### スケジュールリスク

| リスク | 対策 |
|--------|------|
| Phase 4, 6 の遅延 | 事前に詳細設計を完了させる |
| 依存関係の連鎖遅延 | 各フェーズの完了条件を厳守 |

---

## 次のアクション

### 現在の状況

- ✅ プロジェクト構造設計完了
- ✅ アーキテクチャ設計完了
- ✅ 実装フェーズ詳細設計完了
- ⏳ Phase 1 の実装開始待ち

### 次のステップ

1. **Phase 1 開始**
   - Rust ワークスペースの初期化
   - domain クレートの作成
   - ドメインモデルの実装

2. **HANDOFF.md の更新**
   - 次のステップを Phase 1 の詳細タスクに更新

---

**最終更新**: 2026-01-18
**更新者**: Claude Code
