name: Quality Gate

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  validate-structure:
    name: Validate Template Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking required files..."

          # Core files
          test -f README.md || { echo "❌ README.md not found"; exit 1; }
          test -f CLAUDE.md || { echo "❌ CLAUDE.md not found"; exit 1; }
          test -f LICENSE || { echo "❌ LICENSE not found"; exit 1; }
          test -f .gitignore || { echo "❌ .gitignore not found"; exit 1; }

          # Claude Code settings
          test -f .claude/settings.json || { echo "❌ .claude/settings.json not found"; exit 1; }

          # Commands (12 commands)
          test -f .claude/commands/aad/init.md || { echo "❌ /aad:init command not found"; exit 1; }
          test -f .claude/commands/aad/tasks.md || { echo "❌ /aad:tasks command not found"; exit 1; }
          test -f .claude/commands/aad/worktree.md || { echo "❌ /aad:worktree command not found"; exit 1; }
          test -f .claude/commands/aad/status.md || { echo "❌ /aad:status command not found"; exit 1; }
          test -f .claude/commands/aad/integrate.md || { echo "❌ /aad:integrate command not found"; exit 1; }
          test -f .claude/commands/aad/orchestrate.md || { echo "❌ /aad:orchestrate command not found"; exit 1; }
          test -f .claude/commands/aad/gate.md || { echo "❌ /aad:gate command not found"; exit 1; }
          test -f .claude/commands/aad/context.md || { echo "❌ /aad:context command not found"; exit 1; }
          test -f .claude/commands/aad/handoff.md || { echo "❌ /aad:handoff command not found"; exit 1; }
          test -f .claude/commands/aad/retro.md || { echo "❌ /aad:retro command not found"; exit 1; }
          test -f .claude/commands/aad/clone.md || { echo "❌ /aad:clone command not found"; exit 1; }
          test -f .claude/commands/aad/half-clone.md || { echo "❌ /aad:half-clone command not found"; exit 1; }

          # Scripts
          test -f .claude/scripts/context-bar.sh || { echo "❌ context-bar.sh not found"; exit 1; }
          test -f .claude/scripts/install-to-new.sh || { echo "❌ install-to-new.sh not found"; exit 1; }
          test -f .claude/scripts/install-to-existing.sh || { echo "❌ install-to-existing.sh not found"; exit 1; }

          # Templates
          test -f .aad/templates/SPEC-TEMPLATE.md || { echo "❌ SPEC-TEMPLATE.md not found"; exit 1; }
          test -f .aad/templates/TASK-TEMPLATE.md || { echo "❌ TASK-TEMPLATE.md not found"; exit 1; }
          test -f .aad/templates/RETRO-TEMPLATE.md || { echo "❌ RETRO-TEMPLATE.md not found"; exit 1; }
          test -f .aad/templates/TEMPLATE.md || { echo "❌ TEMPLATE.md not found"; exit 1; }

          # Documentation
          test -f .aad/WORKFLOW.md || { echo "❌ WORKFLOW.md not found"; exit 1; }
          test -f .aad/COMMANDS.md || { echo "❌ COMMANDS.md not found"; exit 1; }
          test -f .aad/SETUP.md || { echo "❌ SETUP.md not found"; exit 1; }

          echo "✅ All required files present"

  validate-scripts:
    name: Validate Shell Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Check shell script syntax
        run: |
          echo "Checking shell scripts..."
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            shellcheck --severity=warning -x "$script" || { echo "❌ ShellCheck failed for $script"; exit 1; }
          done
          echo "✅ All shell scripts passed ShellCheck"

  validate-markdown:
    name: Validate Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

  rust-build:
    name: Rust Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build
        run: cargo build --verbose --all-features

      - name: Build tests
        run: cargo build --tests --verbose --all-features

  rust-clippy:
    name: Rust Clippy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  rust-test:
    name: Rust Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --verbose --all-features

  rust-coverage:
    name: Rust Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Generate coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

      - name: Check coverage threshold
        run: |
          coverage=$(cargo llvm-cov --all-features --workspace --summary-only | grep 'TOTAL' | awk '{print $10}' | sed 's/%//')
          echo "Coverage: ${coverage}%"
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "❌ Coverage ${coverage}% is below 80% threshold"
            exit 1
          fi
          echo "✅ Coverage ${coverage}% meets the 80% threshold"

  aad-gate:
    name: AAD Quality Gate
    runs-on: ubuntu-latest
    needs: [rust-build, rust-test, rust-coverage]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build aad binary
        run: cargo build --release

      - name: Run TDD gate check
        run: ./target/release/aad gate TDD

  summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-scripts, validate-markdown, rust-build, rust-clippy, rust-test, rust-coverage, aad-gate]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "Quality Gate Results:"
          echo "- Structure Validation: ${{ needs.validate-structure.result }}"
          echo "- Scripts Validation: ${{ needs.validate-scripts.result }}"
          echo "- Markdown Validation: ${{ needs.validate-markdown.result }}"
          echo "- Rust Build: ${{ needs.rust-build.result }}"
          echo "- Rust Clippy: ${{ needs.rust-clippy.result }}"
          echo "- Rust Test: ${{ needs.rust-test.result }}"
          echo "- Rust Coverage: ${{ needs.rust-coverage.result }}"
          echo "- AAD Gate: ${{ needs.aad-gate.result }}"

          if [ "${{ needs.validate-structure.result }}" != "success" ] || \
             [ "${{ needs.validate-scripts.result }}" != "success" ] || \
             [ "${{ needs.rust-build.result }}" != "success" ] || \
             [ "${{ needs.rust-clippy.result }}" != "success" ] || \
             [ "${{ needs.rust-test.result }}" != "success" ] || \
             [ "${{ needs.rust-coverage.result }}" != "success" ] || \
             [ "${{ needs.aad-gate.result }}" != "success" ]; then
            echo "❌ Quality Gate FAILED"
            exit 1
          fi

          echo "✅ Quality Gate PASSED"
