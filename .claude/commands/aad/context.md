# コンテキスト使用状況確認

## 🔴 重要: 出力指示

コンテキスト確認後、**必ず以下の形式で状況に応じた出力をすること**:

### キーワード凡例
- **解：** - 分析結果、答え
- **告：** - システム通知、実行確認、異常完了報告
- **確認：** - 検知、照合
- **成功しました：** - 正常完了報告
- **否：** - 否定

### 必須出力フォーマット（状況別）

🟢 快適 (0-50%):
```
成功しました：コンテキストに十分な余裕があります。
告：通常通り作業を継続してください。
```

🟡 注意 (50-70%):
```
告：使用率が中程度に達しました。
告：大きなタスクは新セッションを推奨します。
```

🟠 警告 (70-85%):
```
告：使用率が警告レベルです。
告：/aad:handoff の実行を強く推奨します。
```

🔴 危険 (85%+):
```
告：危機的状況です。
告：今すぐ /aad:handoff を実行してください。
```

---

現在のコンテキスト使用率を確認し、70%ルールに基づく推奨アクションを提示します。

## 実行内容

1. **コンテキスト使用率取得**
   - 現在のトークン使用量を取得
   - 総容量に対する割合を計算

2. **ステータス判定**
   - 0-50%: 🟢 快適
   - 50-70%: 🟡 注意
   - 70-85%: 🟠 警告
   - 85-95%: 🔴 危険
   - 95%+: ⛔ 限界

3. **推奨アクション表示**
   - 各ステータスに応じた推奨アクションを提示

4. **セッション情報**
   - セッション開始時刻
   - 経過時間
   - メッセージ数

5. **過去のhandoff履歴**
   - 過去のHANDOFF.mdファイル一覧
   - 最後のhandoff以降の使用量

## 使用方法

```
/aad:context
```

詳細表示：

```
/aad:context --verbose
```

## 出力例

### 快適な状態（0-50%）

```
📊 コンテキスト使用状況

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
使用率: 🟢 45% (90,000 / 200,000 tokens)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ステータス: 🟢 快適

成功しました：コンテキストに十分な余裕があります。
告：通常通り作業を継続してください。

セッション情報:
  開始: 2026-01-11 10:00
  経過時間: 1時間30分
  メッセージ数: 45

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 注意が必要（50-70%）

```
📊 コンテキスト使用状況

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
使用率: 🟡 65% (130,000 / 200,000 tokens)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ステータス: 🟡 注意

告：使用率が中程度に達しました。
大きなタスクで70%を超える可能性があります。
告：大きなタスクは新セッションを推奨します。

セッション情報:
  開始: 2026-01-11 10:00
  経過時間: 2時間45分
  メッセージ数: 78

最後のhandoff:
  なし（初回セッション）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 警告レベル（70-85%）

```
📊 コンテキスト使用状況

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
使用率: 🟠 78% (156,000 / 200,000 tokens)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ステータス: 🟠 警告

告：使用率が警告レベルです。
MPが残り少ない状態に相当します。
告：/aad:handoff の実行を強く推奨します。

セッション情報:
  開始: 2026-01-11 10:00
  経過時間: 3時間50分
  メッセージ数: 112

最後のhandoff:
  2026-01-11 13:00 (50分前)
  使用率: 55% → 78% (23%増加)

⚠️  このまま作業を続けると、コンテキストの質が低下する可能性があります。

次のアクション:
  1. 現在の作業をキリの良いところで完了
  2. /aad:handoff を実行
  3. 新しいセッションで HANDOFF.md を読み込んで再開

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 危険レベル（85-95%）

```
📊 コンテキスト使用状況

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
使用率: 🔴 90% (180,000 / 200,000 tokens)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ステータス: 🔴 危険

告：危機的状況です。
95%で自動圧縮が始まり、情報が失われます。
告：今すぐ /aad:handoff を実行してください。

セッション情報:
  開始: 2026-01-11 10:00
  経過時間: 5時間20分
  メッセージ数: 165

⚠️  危機的状況: あと 10% (20,000 tokens) で限界に達します

今すぐ実行:
  /handoff

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

## 70%ルール

| 使用率 | ステータス | アクション |
|--------|------------|------------|
| 0-50% | 🟢 快適 | 通常作業 |
| 50-70% | 🟡 注意 | 大きなタスクは新セッション推奨 |
| 70-85% | 🟠 警告 | /aad:handoff 実行推奨 |
| 85-95% | 🔴 危険 | 即座に /aad:handoff |
| 95%+ | ⛔ 限界 | 自動圧縮（制御不能） |

## 自動通知

ステータスバー（`context-bar.sh`）で常時表示：

```
Sonnet 4.5 | 📁project | 🔀main | ██████████ 78% 🟠 /aad:handoff推奨
```

## 詳細モード

```
/aad:context --verbose

追加情報:
- システムプロンプトサイズ
- ツール定義サイズ
- 会話履歴サイズ
- ファイル参照サイズ
```

## handoff履歴

過去のhandoffを確認：

```
/aad:context --history

過去のhandoff履歴:
1. 2026-01-11 13:00 - 55% → 新セッション
2. 2026-01-11 16:00 - 72% → 新セッション
3. 現在: 78%
```

## 関連コマンド

- `/aad:handoff` - 引き継ぎドキュメント作成
- `/aad:clone` - 会話クローン
- `/aad:half-clone` - ハーフクローン（コンテキスト削減）

## 計画的なコンテキスト管理

### 推奨ワークフロー

1. **セッション開始時**: `/aad:context` で確認（0%付近）
2. **作業中**: ステータスバーで監視
3. **50%到達**: 大きなタスクは新セッションで
4. **70%到達**: `/aad:handoff` を実行
5. **新セッション**: HANDOFF.md を読み込んで再開

### タスクサイズの目安

- **小タスク（S）**: ~5-10% 使用
- **中タスク（M）**: ~10-20% 使用
- **大タスク（L）**: ~20-30% 使用

## 注意事項

- コンテキストの質は使用率が上がるほど低下します
- 70%は「限界」ではなく「推奨区切り」です
- 新鮮なコンテキストで作業する方が効率的です
- 定期的に `/aad:context` で確認する習慣をつけてください
- 自動圧縮が始まると、重要な情報が失われる可能性があります
